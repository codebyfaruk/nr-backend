{% extends "layout/base.html" %}
{% block extra_css %}
<style>
  /* styles.css */

/* Remove padding from table header and cells */
.table th, .table td {
  padding: 0 !important;  /* Removes padding */
}

/* Optional: Customize the table layout for fixed column widths */
.table {
  table-layout: fixed;
  width: 100%;
}

.table thead th {
  padding: 0 5px 0 5px !important;  /* Removes padding */
  text-align: center; /* Center align header text */

}

.table tbody tr td {
  padding: 0 5px 0 5px !important;  /* Removes padding */
  text-align: center;
}

.table tfoot tr th {
  padding: 0 5px 0 5px !important;  /* Removes padding */
  text-align: center;
}

</style>
{% endblock extra_css %}
{% block content %}
<div class="container mt-4">
    <div class="row g-3">
      <input type="hidden" id="customerId" value=""/>
      <!-- Left: Sales Form -->
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white">Sales Form</div>
          <div class="card-body">
            <form id="salesForm">
              <div class="mb-3">
                <label for="barcode" class="form-label">Barcode</label>
                <input type="text" id="barcode" class="form-control form-control-sm" placeholder="Scan or enter barcode" />
              </div>
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" id="name" class="form-control form-control-sm" placeholder="Product Name" />
              </div>
              <div class="mb-3">
                <label for="price" class="form-label">Selling Price</label>
                <input type="number" id="price" class="form-control form-control-sm" />
              </div>
              <div class="mb-3">
                <label for="qty" class="form-label">Qty</label>
                <input type="number" id="qty" class="form-control form-control-sm" />
              </div>
              <div class="mb-3">
                <label for="discount" class="form-label">Discount</label>
                <input type="number" id="discount" class="form-control form-control-sm" />
              </div>
              <input type="hidden" id="id" value=""/>
              <div class="d-grid">
                <button type="button" class="btn btn-success" id="addToTableBtn"><i class="fas fa-angle-double-right"></i></button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Right: Added Products -->
      <div class="col-md-8">
        <div class="card shadow-sm h-100 d-flex flex-column">
          <div class="card-header bg-info text-white">Added Products</div>

          <!-- Table -->
          <div class="card-body p-2 flex-grow-1 overflow-hidden">
            <div class="table-wrapper" style="max-height: 350px; overflow-x: auto;">
              <table class="table table-sm table-bordered" id="productsTable">
                <thead>
                  <tr>
                    <th class="col-1" style="font-size: 0.70rem;">SL</th> <!-- Very small SL column -->
                    <th class="col-7" style="font-size: 0.70rem;">Product</th>  <!-- Bigger Product column -->
                    <th class="col-2" style="font-size: 0.70rem;">Rate</th>  <!-- Small Rate column -->
                    <th class="col-2" style="font-size: 0.70rem;">Discount</th>  <!-- Small Discount column -->
                    <th class="col-1" style="font-size: 0.70rem;">Qty</th>  <!-- Very small Qty column -->
                    <th class="col-2" style="font-size: 0.70rem;">Amount</th>  <!-- Small Amount column -->
                    <th class="col-2" style="font-size: 0.70rem;">Action</th>  <!-- Small Action column -->
                  </tr>
                </thead>
                <tbody>

                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="4">Totals</th>
                    <th id="totalQty">0</th>
                    <th id="totalAmount">0.00</th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- Footer Buttons: Toggle Left, Create Order Right -->
            <div class="card-footer bg-white">
                <div id="promoFields" class="px-3 py-2 border-bottom" style="display: none;">
                    <div class="row g-2">
                        <div class="col-md-7">
                            <div class="form-group">
                                <div class="input-group"> <!-- smaller size -->
                                    <input type="text" class="form-control" id="couponValue" placeholder="Enter coupon Code" aria-label="Input field">
                                    <button class="btn btn-secondary " type="button" id="applyPromoBtn">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <div class="input-group"> <!-- smaller size -->
                                    <input type="number" class="form-control" id="roundOffValue" placeholder="Round off" aria-label="Input field">
                                    <button class="btn btn-secondary " type="button" id="roundOffBtn">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Promo Inputs (shown when toggled) -->

                    <!-- Toggle Switch -->
                    <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="togglePromo" />
                    <label class="form-check-label fw-semibold ms-2" for="togglePromo">Open Offer</label>
                    </div>
                    <!-- Create Order Button -->
                    <button type="button" class="btn btn-sm btn-primary" id="createOrderBtn">Create Order</button>
                </div>
            </div>
        </div>
      </div>
    </div>
</div>
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock content %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    let isFetching = false;
    let isCouponApplied =  false
    let isRoundOffApplied = false
    let currentDiscount = 0;
    let currentRoundoff = 0;

    $.ajaxSetup({
      headers: { "X-CSRFToken": $("meta[name='csrf-token']").attr("content") }
    });

    // Function to clear the form fields
    function clearForm() {
      $('#barcode').val('');
      $('#name').val('');
      $('#price').val('');
      $('#qty').val('');
      $('#discount').val('');
      $('#id').val('');
    }

    // Function to update totals
    function updateTotals() {
      let totalQty = 0;
      let totalAmount = 0;

      $('#productsTable tbody tr').each(function () {
        const qty = parseInt($(this).find('td:nth-child(5)').text());
        const amount = parseFloat($(this).find('td:nth-child(6)').text());
        totalQty += qty;
        totalAmount += amount;
      });

      $('#totalQty').text(totalQty);
      $('#totalAmount').text(totalAmount.toFixed(2));
    }

    // Function to add product to the table
    function addProductToTable(product) {
      const tableBody = $('#productsTable tbody');
      const qtyToAdd = parseInt($('#qty').val());
      const discount = parseFloat(product.discount_amount);
      const price = parseFloat(product.displayed_price);
      const productId = product.id; // Use product ID to uniquely identify it

      let rowUpdated = false;

      // Loop through rows to check if product already exists by product ID
      $('#productsTable tbody tr').each(function () {
        const row = $(this);
        const existingProductId = row.data('id'); // Store product ID in data attribute

        if (existingProductId === productId) {
          const qtyCell = row.find('td:nth-child(5)');
          const amountCell = row.find('td:nth-child(6)');

          let currentQty = parseInt(qtyCell.text());
          let newQty = currentQty + qtyToAdd;
          let newAmount = (price - discount) * newQty;

          qtyCell.text(newQty);
          amountCell.text(newAmount.toFixed(2));
          rowUpdated = true;
          return false; // break loop
        }
      });

      // If product doesn't exist, add it as a new row
      if (!rowUpdated) {
        const rowCount = tableBody.children('tr').length;
        const newRow = `
          <tr data-id="${productId}">
            <td>${rowCount + 1}</td>
            <td>${product.name}</td>
            <td>${price}</td>
            <td>${discount}</td>
            <td>${qtyToAdd}</td>
            <td>${(price - discount) * qtyToAdd}</td>
            <td>
              <a href="javascript:void(0);" class="text-info p-1 editProductBtn"><i class="fas fa-angle-double-left"></i></a>
              <a href="javascript:void(0);"class="text-danger p-1 removeProductBtn"><i class="fas fa-trash-alt"></i></a>
            </td>
          </tr>`;
        tableBody.append(newRow);
      }

      updateTotals();
      clearForm();
    }

    // New function to handle product edit
    function editProduct(row) {
      const productId = row.data('id');
      const nameCell = row.find('td:nth-child(2)');
      const priceCell = row.find('td:nth-child(3)');
      const discountCell = row.find('td:nth-child(4)');
      const qtyCell = row.find('td:nth-child(5)');

      const productName = nameCell.text();
      const sellingPrice = parseFloat(priceCell.text());
      const currentQty = parseInt(qtyCell.text());
      const currentDiscount = parseFloat(discountCell.text()); // Directly parse discount value

      // Set current values in form fields for editing
      $('#id').val(productId);
      $('#name').val(productName);
      $('#price').val(sellingPrice);
      $('#qty').val(currentQty);
      $('#discount').val(currentDiscount);

      // Temporarily remove the row to allow for editing
      row.remove();
      updateTotals(); // Recalculate totals after row removal
    }

    // Function to update serial numbers (SL)
    function updateSerialNumbers() {
      $('#productsTable tbody tr').each(function (index) {
        $(this).find('td:first').text(index + 1);  // Assuming SL is in the first <td>
      });
    }

    // Function to update footer with discount, roundoff, and grand total
    function updateFooter(value) {
      // Update values based on the passed object
      if (typeof value === 'object') {
          if ('discount' in value) currentDiscount = parseFloat(value.discount || 0);
          if ('roundoff' in value) currentRoundoff = parseFloat(value.roundoff || 0);
      }

      const footer = $('#productsTable tfoot');
      footer.find('.dynamic-row').remove(); // Remove previous discount/roundoff/grandtotal rows

      const totalAmount = parseFloat($('#totalAmount').text()) || 0;
      let grandTotal = totalAmount - currentDiscount - currentRoundoff;

      // Add Discount row
      if (currentDiscount > 0) {
          $('<tr class="dynamic-row discount-row">')
              .append('<th colspan="5" class="text-end text-muted">Coupon Discount</th>')
              .append(`<th class="text-danger">- ${currentDiscount.toFixed(2)}</th>`)
              .append('<th><a href="javascript:void(0);"class="text-danger p-1 removeCouponDiscount"><i class="fas fa-trash-alt"></i></a></th>')
              .insertAfter(footer.find('tr:last'));
      }

      // Add Roundoff row
      if (currentRoundoff > 0) {
          $('<tr class="dynamic-row roundoff-row">')
              .append('<th colspan="5" class="text-end text-muted">Round Off</th>')
              .append(`<th class="text-warning">- ${currentRoundoff.toFixed(2)}</th>`)
              .append('<th><a href="javascript:void(0);"class="text-danger p-1 removeRoundOff"><i class="fas fa-trash-alt"></i></a></th>')
              .insertAfter(footer.find('tr:last'));
      }

      // Add Grand Total row
      if (currentDiscount > 0 || currentRoundoff > 0) {
          $('<tr class="dynamic-row grandtotal-row fw-bold">')
              .append('<th colspan="5" class="text-end">Grand Total</th>')
              .append(`<th>${grandTotal.toFixed(2)}</th>`)
              .append('<th></th>')
              .insertAfter(footer.find('tr:last'));
      }
    }

    // Handle barcode input and fetch product
    $('#barcode').on('keyup', function () {
      const query = $('#barcode').val().trim();
      if (!query || isFetching) return;

      if (query.length == 12) {
        isFetching = true;
        $.ajax({
          url: '{% url "api_sales_product-list" %}',
          data: { 'barcode': query },
          type: 'GET',
          success: function (product) {
            if (product && product.barcode == query) {
              // Fill the form fields
              $('#name').val(product.name);
              $('#price').val(product.displayed_price);
              $('#discount').val(product.discount_amount);
              $('#qty').val(1);

              // Wait 1 second, then trigger the "add to table" button click
              setTimeout(function () {
                addProductToTable(product);
                isFetching = false;
              }, 1000);
            } else {
              alert('No matching product found.');
            }
          },
          error: function () {
            alert('Error fetching product. Please try again.');
          }
        });
      }
    });

    // Handle "Add to Table" button click
    $("#addToTableBtn").on("click", function () {
      const id = $("#id").val().trim();
      const name = $("#name").val().trim();
      const price = parseFloat($("#price").val());
      const qty = parseInt($("#qty").val());
      const discount = parseFloat($("#discount").val());

      if (!barcode || !name || isNaN(price) || isNaN(qty) || isNaN(discount)) {
        alert("Please fill in all fields correctly.");
        return;
      }

      // Create a product object
      const product = {
        id: id,
        barcode: barcode,
        name: name,
        displayed_price: price,
        discount_amount: discount,
        qty: qty
      };

      addProductToTable(product);
      updateSerialNumbers();
    });

    // Handle edit button click to edit product quantity and discount
    $(document).on('click', '.editProductBtn', function () {
      const row = $(this).closest('tr');
      editProduct(row);
      updateSerialNumbers();
    });

    // Handle remove product button click
    $(document).on('click', '.removeProductBtn', function () {
      const row = $(this).closest('tr');
      row.remove();
      updateSerialNumbers();  // Update SL after removal
      updateTotals();         // Update totals
    });

    // Handle toggle switch for promo fields
    $('#togglePromo').on('change', function () {
      $('#promoFields').slideToggle(this.checked);
    });

    // Handle apply promo button click
    $("#applyPromoBtn").on("click", function () {
      var totalAmount = parseFloat($("#totalAmount").text());
      var couponValue = $("#couponValue").val().trim();
      var customerId = $("#customerId").val().trim();

      if (isCouponApplied) return;

      $.ajax({
        url: '{% url "api_discount-apply" %}',
        type: 'POST',
        data: JSON.stringify({
            'code': couponValue,
            'total': totalAmount,
            'customer_id': customerId || null
        }),
        contentType: 'application/json',
        success: function (response) {
          if (response.discount > 0) {
            updateFooter({ discount: response.discount })
            isCouponApplied = true;
          }

        },
        error: function (error) {
          Swal.fire({
              icon: 'error',
              title: 'Oops!',
              text: error.responseJSON.detail,
              confirmButtonColor: '#d33',
          });
        }
      });
    });

    // Handle round off button click
    $("#roundOffBtn").on("click", function () {
      if (isRoundOffApplied) return;

      var roundOffValue = parseFloat($("#roundOffValue").val());
      if (isNaN(roundOffValue)) {
        alert("Please enter a valid round off value.");
        return;
      }
      updateFooter({ roundoff: roundOffValue });
      isRoundOffApplied = true;
    });

    // Remove Coupon Discount
    $(document).on('click', '.removeCouponDiscount', function () {
      currentDiscount = 0;
      updateFooter({});
      isCouponApplied=false
    });

    // Remove Roundoff
    $(document).on('click', '.removeRoundOff', function () {
      currentRoundoff = 0;
      updateFooter({});
      isRoundOffApplied=false
    });

    $("#createOrderBtn").on("click", function () {
      var $clonedTable = $("#productsTable").clone();

      // Find the index of the last column (assumed to be "Action")
      var actionColIndex = $clonedTable.find("thead th").length - 1;

      // Remove the "Action" column header
      $clonedTable.find("thead tr").each(function () {
          $(this).find("th").eq(actionColIndex).remove();
      });

      // Remove the "Action" column from each row
      $clonedTable.find("tbody tr").each(function () {
          $(this).find("td").eq(actionColIndex).remove();
      });

      // Adjust any colspan values
      $clonedTable.find("[colspan]").each(function () {
          var currentSpan = parseInt($(this).attr("colspan"), 10);
          if (currentSpan > 1) {
              $(this).attr("colspan", currentSpan - 1);
          }
      });

      // Convert cleaned table to HTML
      var tableHTML = $("<div>").append($clonedTable).html();
      console.log(tableHTML);

      // Store in sessionStorage
      sessionStorage.setItem("invoiceTable", tableHTML);
      location.href = "{% url 'invoice' %}";
    });

  });
</script>
{% endblock extra_js %}
